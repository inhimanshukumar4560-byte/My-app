// рдЬрд╝рд░реВрд░реА рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬ рдХреЛ рдЗрдореНрдкреЛрд░реНрдЯ рдХрд░рдирд╛
const express = require('express');
const crypto = require('crypto');
const cors = require('cors');
// .env рдХреА рдЕрдм рдЬрд╝рд░реВрд░рдд рдирд╣реАрдВ рд╣реИ

const app = express();
app.use(cors());

// ======================================================================================
// ==================== рдЕрдкрдиреА SECRET KEY рд╕реАрдзреЗ рдпрд╣рд╛рдБ рдбрд╛рд▓реЗрдВ =======================
// ======================================================================================
// 'YOUR_WEBHOOK_SECRET_HERE' рдХреА рдЬрдЧрд╣ рдЕрдкрдиреА рдЕрд╕рд▓реА рд╡реЗрдмрд╣реБрдХ рд╕реАрдХреНрд░реЗрдЯ рдХреА рдбрд╛рд▓реЗрдВ
const MY_PERFECT_WEBHOOK_SECRET = 'YOUR_WEBHOOK_SECRET_HERE'; 
// ======================================================================================


app.post('/webhook', express.raw({ type: 'application/json' }), (req, res) => {
    
    // рдЕрдм рд╣рдо process.env рдХреА рдЬрдЧрд╣ рд╕реАрдзреЗ рдЕрдкрдиреА рдХреА рдХрд╛ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░реЗрдВрдЧреЗ
    const webhookSecret = MY_PERFECT_WEBHOOK_SECRET; 
    const signatureFromRazorpay = req.headers['x-razorpay-signature'];
    
    console.log("--- [рдЖрдЦрд┐рд░реА рдЬрд╛рд╕реВрд╕ рд░рд┐рдкреЛрд░реНрдЯ] ---");
    console.log("рдПрдХ рдирдпрд╛ рд╡реЗрдмрд╣реБрдХ рдорд┐рд▓рд╛ред рдЖрдЦрд┐рд░реА рдЬрд╛рдБрдЪ рд╢реБрд░реВред");

    try {
        // рд╕рд░реНрд╡рд░ рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ рд╕рд┐рдЧреНрдиреЗрдЪрд░ рдмрдирд╛ рд░рд╣рд╛ рд╣реИ
        const shasum = crypto.createHmac('sha256', webhookSecret);
        shasum.update(req.body);
        const digestGeneratedByServer = shasum.digest('hex');

        console.log(`рд╕рд░реНрд╡рд░ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╕рд┐рдЧреНрдиреЗрдЪрд░: ${digestGeneratedByServer}`);
        console.log(`рд░реЗрдЬрд░рдкреЗ рджреНрд╡рд╛рд░рд╛ рднреЗрдЬрд╛ рдЧрдпрд╛ рд╕рд┐рдЧреНрдиреЗрдЪрд░: ${signatureFromRazorpay}`);

        // рдЕрдм рд╣рдо рд╕рдЪреНрдЪрд╛рдИ рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВрдЧреЗ
        if (digestGeneratedByServer === signatureFromRazorpay) {
            console.log("ЁЯОЙЁЯОЙЁЯОЙ VICTORY! рд╕рд┐рдЧреНрдиреЗрдЪрд░ рдореИрдЪ рд╣реЛ рдЧрдпрд╛! рдЕрдкрд░рд╛рдзреА рдкрдХрдбрд╝рд╛ рдЧрдпрд╛! ЁЯОЙЁЯОЙЁЯОЙ");
            console.log("рд╕рдорд╕реНрдпрд╛ Render рдХреЗ Environment Variable рдореЗрдВ рдереАред");
        } else {
            console.log("тЭМ FAILURE! рд╕рд┐рдЧреНрдиреЗрдЪрд░ рдЕрднреА рднреА рдореИрдЪ рдирд╣реАрдВ рд╣реБрдЖред рд╕рдорд╕реНрдпрд╛ Render рдХреЗ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд╣реА рд╣реИ рдЬреЛ рдбреЗрдЯрд╛ рдХреЛ рдмрджрд▓ рд░рд╣рд╛ рд╣реИред");
        }
        
        console.log("--- [рд░рд┐рдкреЛрд░реНрдЯ рдЦрддреНрдо] ---");

        res.json({ status: 'ok' });

    } catch (error) {
        console.error("тЭМ рд╡реЗрдмрд╣реБрдХ рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рддреЗ рд╕рдордп рдХреЛрдИ рдмрд╣реБрдд рдмрдбрд╝реА рдПрд░рд░ рдЖрдИ:", error.message);
        res.status(500).send('Webhook error.');
    }
});


const PORT = process.env.PORT || 10000;
app.listen(PORT, () => {
    console.log(`ЁЯЪА рдЖрдЦрд┐рд░реА рдЬрд╛рд╕реВрд╕ рд╕рд░реНрд╡рд░ рдкреЛрд░реНрдЯ ${PORT} рдкрд░ рд▓рд╛рдЗрд╡ рд╣реИ рдФрд░ рдЬреАрдд рдХрд╛ рдЗрдВрддрдЬрд╝рд╛рд░ рдХрд░ рд░рд╣рд╛ рд╣реИред`);
});
